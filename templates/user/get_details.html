{% extends "base.html" %}
{% load static %}

{% block head %}
<!-- Bootstrap 5.3 Bundle (with Popper) - single reference -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
<!-- Bootstrap Icons (critical for visual) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    /* ----- ROOT VARIABLES (unchanged, exactly as provided) ----- */
    :root {
        --primary: #2e7d32;
        --primary-dark: #1b5e20;
        --primary-light: #4caf50;
        --secondary: #ff9800;
        --dark: #333333;
        --light: #f8f9fa;
        --gray: #6c757d;
        --border: #e0e0e0;
        --success: #28a745;
        --danger: #dc3545;
        --warning: #ffc107;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .product-page {
        padding-top: 2rem;
        padding-bottom: 4rem;
    }

    /* Back Button */
    .back-btn {
        font-size: 1.5rem;
        color: #555;
        transition: color 0.3s ease;
        padding: 0.5rem;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 3rem;
        height: 3rem;
    }

    .back-btn:hover {
        color: var(--primary);
        background-color: rgba(46, 125, 50, 0.05);
    }

    /* Product Image Gallery */
    .product-gallery {
        position: sticky;
        top: 2rem;
    }

    .main-image {
        width: 100%;
        height: 500px;
        object-fit: contain;
        border-radius: 12px;
        box-shadow: var(--shadow);
        background: white;
        padding: 2rem;
        transition: transform 0.3s ease;
    }

    .main-image:hover {
        transform: scale(1.01);
    }

    .thumbnail-container {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        justify-content: center;
    }

    .thumbnail {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        padding: 0.25rem;
        background: white;
    }

    .thumbnail.active,
    .thumbnail:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
    }

    /* Product Info */
    .product-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--dark);
        line-height: 1.2;
        margin-bottom: 1rem;
    }

    .rating-container {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .rating-stars {
        color: var(--warning);
        font-size: 1.25rem;
    }

    .rating-text {
        color: var(--gray);
        font-weight: 500;
    }

    /* Pricing */
    .current-price {
        font-size: 3rem;
        font-weight: 800;
        color: var(--primary);
        line-height: 1;
    }

    .old-price {
        font-size: 1.5rem;
        color: var(--gray);
        text-decoration: line-through;
        margin-left: 0.75rem;
    }

    .discount-badge {
        background: var(--danger);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
        margin-left: 1rem;
        vertical-align: super;
    }

    /* Variant Selector */
    .variant-label {
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: var(--dark);
        font-size: 1.1rem;
    }

    .variant-btn {
        padding: 0.75rem 1.5rem;
        border: 2px solid var(--border);
        border-radius: 8px;
        background: white;
        color: var(--dark);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 120px;
        text-align: center;
    }

    .variant-btn:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
    }

    .variant-btn.active {
        border-color: var(--primary);
        background-color: rgba(46, 125, 50, 0.05);
        color: var(--primary);
        font-weight: 600;
    }

    /* Quantity Selector */
    .quantity-btn {
        width: 45px;
        height: 45px;
        border: none;
        background: #f8f9fa;
        font-size: 1.25rem;
        color: var(--dark);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .quantity-btn:hover {
        background: var(--primary-light);
        color: white;
    }

    /* Action Buttons */
    .btn-buy-now,
    .btn-add-cart {
        flex: 1;
        padding: 1.25rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
    }

    .btn-buy-now {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
    }

    .btn-buy-now:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(46, 125, 50, 0.3);
    }

    .btn-add-cart {
        background: white;
        color: var(--primary);
        border: 2px solid var(--primary);
    }

    .btn-add-cart:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(46, 125, 50, 0.2);
    }

    /* Features List */
    .features-list {
        list-style: none;
        padding-left: 0;
        margin-bottom: 2rem;
    }

    .features-list li {
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1rem;
    }

    .features-list li:last-child {
        border-bottom: none;
    }

    .feature-icon {
        color: var(--primary);
        font-size: 1.25rem;
        width: 24px;
    }

    /* Product Tabs */
    .product-tabs {
        margin-top: 3rem;
    }

    .nav-tabs .nav-link {
        border: none;
        color: var(--gray);
        font-weight: 600;
        font-size: 1rem;
        padding: 1rem 1.5rem;
        border-radius: 8px 8px 0 0;
        transition: all 0.3s ease;
    }

    .nav-tabs .nav-link:hover {
        color: var(--primary);
        background-color: rgba(46, 125, 50, 0.05);
    }

    .nav-tabs .nav-link.active {
        color: var(--primary);
        background-color: white;
        border-bottom: 3px solid var(--primary);
    }

    .tab-content {
        padding: 2rem;
        background: white;
        border-radius: 0 0 12px 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        border-top: none;
    }

    /* Delivery & Payment Info */
    .info-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .info-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        transition: transform 0.3s ease;
    }

    .info-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-hover);
    }

    .info-card-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        color: white;
        font-size: 1.5rem;
    }

    /* Payment Methods */
    .payment-methods {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
        flex-wrap: wrap;
    }

    .payment-method {
        width: 60px;
        height: 40px;
        border: 1px solid var(--border);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        padding: 0.5rem;
    }

    /* Related Products */
    .shadow-hover {
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
    }
    
    .shadow-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1) !important;
        border-color: var(--primary-light);
    }
    
    .product-card:hover .card-img-top {
        transform: scale(1.05);
    }
    
    .quick-view-btn {
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s ease;
    }
    
    .product-card:hover .quick-view-btn {
        opacity: 1;
        transform: translateY(0);
    }
    
    .product-name {
        height: 2.8em;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }
    
    .empty-state {
        padding: 3rem;
        background: #f8f9fa;
        border-radius: 10px;
    }

    /* Toast Notification */
    .toast-notification {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: white;
        border-radius: 10px;
        padding: 1.25rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 1rem;
        transform: translateX(150%);
        transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        z-index: 1050;
        max-width: 350px;
        border-left: 4px solid var(--success);
    }

    .toast-notification.show {
        transform: translateX(0);
    }

    .toast-icon {
        width: 40px;
        height: 40px;
        background: var(--success);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
    }

    /* Responsive */
    @media (max-width: 992px) {
        .product-title {
            font-size: 2rem;
        }
        .current-price {
            font-size: 2.5rem;
        }
        .product-gallery {
            position: static;
            margin-bottom: 2rem;
        }
        .main-image {
            height: 400px;
        }
    }

    @media (max-width: 768px) {
        .main-image {
            height: 350px;
        }
        .thumbnail {
            width: 70px;
            height: 70px;
        }
    }
    a{
        text-decoration:none;
    }

    /* ----- FIXES & ENHANCEMENTS (preserving original identity) ----- */
    /* Fix for payment icons (FontAwesome fallback) */
    .payment-method i {
        font-size: 1.8rem;
    }
    /* Ensure quick view modal is usable */
    .modal-backdrop {
        background-color: rgba(0,0,0,0.3);
    }
    /* Active thumbnail polish */
    .thumbnail.active {
        border-width: 3px;
        box-shadow: 0 0 0 2px rgba(46,125,50,0.2);
    }
    /* Disabled button state for out of stock */
    .btn-out-of-stock {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
    }
    /* Better quantity input */
    #productQty {
        border: 1px solid var(--border);
        border-radius: 8px;
        font-weight: 600;
    }
    /* remove spinner arrows */
    #productQty::-webkit-inner-spin-button, 
    #productQty::-webkit-outer-spin-button { 
        opacity: 0.5;
    }
    /* related product card consistent height */
    .product-card .card-body {
        padding: 1rem 1rem 1.25rem;
    }
    .product-image-wrapper {
        border-radius: 12px 12px 0 0;
        overflow: hidden;
    }
    /* quick view button color matches theme */
    .quick-view-btn:hover {
        background-color: var(--primary) !important;
        border-color: var(--primary) !important;
    }
    /* default link color */
    a:not(.btn) {
        color: var(--primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="product-page py-4">
    <div class="container">
        <!-- Back Button (restored visibility) -->
        <a href="javascript:history.back()" class="back-btn mb-4 d-inline-block" aria-label="Go back">
            <i class="bi bi-arrow-left"></i>
        </a>

        <div class="row g-5 align-items-start">
            <!-- Left: Image Gallery -->
            <div class="col-lg-6 col-md-6">
                <div class="product-gallery">
                    <!-- Main Image -->
                    <div class="main-image-container mb-4 text-center">
                        <img id="mainProductImage" 
                             src="{% if get.image %}{{ get.image.url }}{% else %}https://images.unsplash.com/photo-1586201375761-83865001e31c?auto=format&fit=crop&w=1000&q=80{% endif %}" 
                             alt="{{ get.name|default:'Product image' }}"
                             class="img-fluid rounded shadow-sm main-image"
                             style="object-fit: contain; max-height: 500px; width: auto; max-width: 100%;">
                    </div>

                    <!-- Thumbnails -->
                    <div class="thumbnail-container d-flex gap-2 flex-wrap justify-content-start">
                        {% if get.images.all %}
                            {% for img in get.images.all|slice:":4" %}
                                <img src="{{ img.url }}" 
                                     class="thumbnail {% if forloop.first %}active{% endif %} rounded border"
                                     data-image="{{ img.url }}" 
                                     alt="{{ get.name }} thumbnail"
                                     onclick="document.getElementById('mainProductImage').src = this.dataset.image; 
                                              document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                                              this.classList.add('active');">
                            {% endfor %}
                        {% else %}
                            <!-- Fallback thumbnails (single) -->
                            <img src="https://images.unsplash.com/photo-1586201375761-83865001e31c?auto=format&fit=crop&w=200&q=80"
                                 class="thumbnail active rounded border" 
                                 data-image="https://images.unsplash.com/photo-1586201375761-83865001e31c?auto=format&fit=crop&w=1000&q=80"
                                 alt="product thumbnail"
                                 onclick="document.getElementById('mainProductImage').src = this.dataset.image; 
                                          document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                                          this.classList.add('active');">
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right: Product Details -->
            <div class="col-lg-6 col-md-6">
                <!-- Stock Status -->
                <div class="d-flex align-items-center mt-2 mb-3">
                    {% if get.stock > 0 %}
                    <span class="badge bg-success d-flex align-items-center p-2 fs-6 shadow-sm">
                        <i class="bi bi-check-circle-fill me-2"></i> In Stock
                    </span>
                    {% else %}
                    <span class="badge bg-danger d-flex align-items-center p-2 fs-6 shadow-sm">
                        <i class="bi bi-x-circle-fill me-2"></i> Out of Stock
                    </span>
                    {% endif %}
                </div>

                <!-- Product Title & Description -->
                <h1 class="product-title mb-2">{{ get.name|default:"Premium California Almonds" }}</h1>
                <p class="text-muted mb-3">{{ get.description|default:"Fresh, crunchy, and naturally rich almonds – perfect for healthy snacking." }}</p>

                <!-- Rating -->
                <div class="rating-container mb-3">
                    <div class="rating-stars text-warning">
                        <i class="bi bi-star-fill"></i>
                        <i class="bi bi-star-fill"></i>
                        <i class="bi bi-star-fill"></i>
                        <i class="bi bi-star-fill"></i>
                        <i class="bi bi-star-half"></i>
                    </div>
                    <span class="rating-text text-muted small">4.5 (128 reviews)</span>
                </div>

                <!-- Pricing -->
                <div class="pricing-container mb-3">
                    <div class="d-flex align-items-baseline flex-wrap gap-2">
                        <span class="current-price fs-3 fw-bold text-success">₹{{ get.price|default:"599" }}</span>
                        {% if get.old_price or get.discount %}
                        <span class="old-price text-muted text-decoration-line-through">₹{{ get.old_price|default:get.price|add:"200" }}</span>
                        <span class="discount-badge badge bg-warning text-dark">Save {{ get.discount_percentage|default:"25" }}%</span>
                        {% endif %}
                    </div>
                    <p class="small text-muted mt-1">Inclusive of all taxes | Free shipping on orders above ₹499</p>
                </div>

                <!-- Variants -->
                {% if get.variants.all %}
                <div class="variant-section mb-4">
                    <h5 class="variant-label">Select Size / Weight</h5>
                    <div class="variant-options d-flex flex-wrap gap-2">
                        {% for variant in get.variants.all %}
                        <button class="variant-btn {% if forloop.first %}active{% endif %}" 
                                data-price="{{ variant.price }}" 
                                data-id="{{ variant.id }}"
                                onclick="document.querySelectorAll('.variant-btn').forEach(b => b.classList.remove('active')); this.classList.add('active');">
                            {{ variant.name }} - ₹{{ variant.price }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Quantity -->
                <div class="quantity-container mb-4">
                    <h5 class="variant-label">Quantity:</h5>
                    <div class="quantity-selector d-flex align-items-center gap-2">
                        <button class="quantity-btn btn btn-outline-secondary" id="decrementQty" aria-label="Decrease quantity">−</button>
                        <input type="number" class="form-control text-center" id="productQty" value="1" min="1" max="10" style="width:70px;" inputmode="numeric">
                        <button class="quantity-btn btn btn-outline-secondary" id="incrementQty" aria-label="Increase quantity">+</button>
                    </div>
                    <small class="text-muted">Max 10 units per order</small>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons d-flex gap-3 mb-4">
                    {% if get.stock > 0 %}
                    <a href="" class="btn-buy-now text-white text-decoration-none" id="buyNowBtn">
                        <i class="bi bi-lightning-fill"></i> BUY NOW
                    </a>
                    <button class="btn-add-cart text-decoration-none" id="addToCartBtn" onclick="addToCart(this)">
                        <i class="bi bi-cart-plus"></i> ADD TO CART
                    </button>
                    {% else %}
                    <div class="w-100 text-center p-3 bg-light rounded border">
                        <span class="text-danger fw-bold"><i class="bi bi-x-octagon-fill me-2"></i>Currently Out of Stock</span>
                        <p class="text-muted small mt-2 mb-0">We'll notify you when it's back.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Key Features -->
                <div class="mb-4">
                    <h5 class="variant-label">Key Features</h5>
                    <ul class="features-list">
                        <li>
                            <i class="bi bi-check-circle feature-icon"></i>
                            <span>100% Natural & Organic, No Preservatives</span>
                        </li>
                        <li>
                            <i class="bi bi-check-circle feature-icon"></i>
                            <span>{{ get.name|default:"Almonds" }}, Handpicked Selection</span>
                        </li>
                        <li>
                            <i class="bi bi-check-circle feature-icon"></i>
                            <span>Rich in Vitamin E, Protein & Healthy Fats</span>
                        </li>
                        <li>
                            <i class="bi bi-check-circle feature-icon"></i>
                            <span>Vacuum Packed for Freshness & Long Shelf Life</span>
                        </li>
                        <li>
                            <i class="bi bi-check-circle feature-icon"></i>
                            <span>Certified Quality & Food Safety Standards</span>
                        </li>
                    </ul>
                </div>

                <!-- Delivery & Payment Info Cards -->
                <div class="info-cards">
                    <div class="info-card">
                        <div class="info-card-icon">
                            <i class="bi bi-truck"></i>
                        </div>
                        <h5>Fast Delivery</h5>
                        <p>Free delivery on orders above ₹499. Delivery within 2-4 business days.</p>
                    </div>

                    <div class="info-card">
                        <div class="info-card-icon">
                            <i class="bi bi-shield-check"></i>
                        </div>
                        <h5>Quality Guarantee</h5>
                        <p>100% satisfaction guarantee. Return within 7 days if not satisfied.</p>
                    </div>

                    <div class="info-card">
                        <div class="info-card-icon">
                            <i class="bi bi-credit-card"></i>
                        </div>
                        <h5>Secure Payment</h5>
                        <p>Pay with confidence using our secure payment gateway.</p>
                        <div class="payment-methods">
                            <div class="payment-method">
                                <i class="bi bi-credit-card" style="color:#1a1f71;"></i> <!-- Visa substitute -->
                            </div>
                            <div class="payment-method">
                                <i class="bi bi-credit-card" style="color:#eb001b;"></i> <!-- MC -->
                            </div>
                            <div class="payment-method">
                                <i class="bi bi-credit-card" style="color:#006fcf;"></i> <!-- Amex -->
                            </div>
                            <div class="payment-method">
                                <i class="bi bi-paypal" style="color:#003087;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Tabs -->
        <div class="product-tabs">
            <ul class="nav nav-tabs" id="productTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="description-tab" data-bs-toggle="tab"
                        data-bs-target="#description" type="button" role="tab">Description</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="nutrition-tab" data-bs-toggle="tab" data-bs-target="#nutrition"
                        type="button" role="tab">Nutrition Facts</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews"
                        type="button" role="tab">Customer Reviews</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="faq-tab" data-bs-toggle="tab" data-bs-target="#faq" type="button"
                        role="tab">FAQs</button>
                </li>
            </ul>
            <div class="tab-content" id="productTabContent">
                <!-- Description Tab -->
                <div class="tab-pane fade show active" id="description" role="tabpanel">
                    <h4 class="mb-3">About This Product</h4>
                    <p class="text-muted" style="line-height: 1.8;">
                        {{ get.full_description|default:"Our premium California almonds are carefully selected from the finest orchards, ensuring superior quality and taste. Each almond is handpicked, sun-dried, and vacuum-packed to preserve natural flavors, nutrients, and freshness. Rich in essential vitamins, minerals, and antioxidants, these almonds are perfect for healthy snacking, baking, or as nutritional supplements." }}
                    </p>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h5 class="mb-3">Storage Instructions</h5>
                            <ul class="text-muted">
                                <li>Store in a cool, dry place away from direct sunlight</li>
                                <li>Keep in an airtight container after opening</li>
                                <li>Refrigerate for extended shelf life</li>
                                <li>Consume within 6 months for best quality</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5 class="mb-3">Best Uses</h5>
                            <ul class="text-muted">
                                <li>Healthy snacking between meals</li>
                                <li>Add to breakfast cereals and smoothies</li>
                                <li>Perfect for baking and dessert preparations</li>
                                <li>Ideal for gifting during festive seasons</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Nutrition Facts Tab -->
                <div class="tab-pane fade" id="nutrition" role="tabpanel">
                    <h4 class="mb-3">Nutritional Information</h4>
                    <p class="text-muted mb-4">Per 100g serving</p>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <tbody>
                                <tr><td><strong>Energy</strong></td><td>579 kcal</td></tr>
                                <tr><td><strong>Protein</strong></td><td>21g</td></tr>
                                <tr><td><strong>Carbohydrates</strong></td><td>22g</td></tr>
                                <tr><td><strong>Sugar</strong></td><td>4.4g (Natural)</td></tr>
                                <tr><td><strong>Dietary Fiber</strong></td><td>12.5g</td></tr>
                                <tr><td><strong>Fat</strong></td><td>50g</td></tr>
                                <tr><td><strong>Saturated Fat</strong></td><td>3.8g</td></tr>
                                <tr><td><strong>Vitamin E</strong></td><td>25.6mg (171% DV)</td></tr>
                                <tr><td><strong>Magnesium</strong></td><td>270mg (68% DV)</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Reviews Tab -->
                <div class="tab-pane fade" id="reviews" role="tabpanel">
                    <h4 class="mb-3">Customer Reviews</h4>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center p-4 bg-light rounded">
                                <h2 class="text-primary">4.5/5</h2>
                                <div class="rating-stars fs-3 mb-2">
                                    <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                                    <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                                    <i class="bi bi-star-half"></i>
                                </div>
                                <p class="text-muted">128 ratings</p>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="review-list">
                                <div class="review-item border-bottom pb-3 mb-3">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-1">Excellent Quality</h6>
                                        <small class="text-muted">2 days ago</small>
                                    </div>
                                    <div class="rating-stars mb-2">
                                        <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                                        <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                                        <i class="bi bi-star-fill"></i>
                                    </div>
                                    <p class="text-muted mb-1">Fresh and premium quality almonds. Will definitely purchase again!</p>
                                    <small class="text-muted">- Rajesh Kumar</small>
                                </div>
                                <div class="review-item border-bottom pb-3 mb-3">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-1">Good Value</h6>
                                        <small class="text-muted">1 week ago</small>
                                    </div>
                                    <div class="rating-stars mb-2">
                                        <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                                        <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                                        <i class="bi bi-star"></i>
                                    </div>
                                    <p class="text-muted mb-1">Fresh and tasty. Packaging could be better, but overall satisfied.</p>
                                    <small class="text-muted">- Priya Sharma</small>
                                </div>
                                <div class="review-item pb-3 mb-3">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-1">Best Almonds Ever!</h6>
                                        <small class="text-muted">2 weeks ago</small>
                                    </div>
                                    <div class="rating-stars mb-2">
                                        <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                                        <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                                        <i class="bi bi-star-fill"></i>
                                    </div>
                                    <p class="text-muted mb-1">Perfectly crunchy and fresh. Love the quality!</p>
                                    <small class="text-muted">- Amit Patel</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FAQ Tab -->
                <div class="tab-pane fade" id="faq" role="tabpanel">
                    <h4 class="mb-3">Frequently Asked Questions</h4>
                    <div class="accordion" id="faqAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                    What is the shelf life of these almonds?
                                </button>
                            </h2>
                            <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">Our almonds have a shelf life of 6 months when stored in a cool, dry place. For extended freshness, refrigerate after opening. Vacuum packing ensures they stay fresh longer.</div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                    Are these preservative-free?
                                </button>
                            </h2>
                            <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">Yes, all our almonds are 100% natural with no added preservatives, colors, or artificial flavors. They are sun-dried naturally to preserve nutrients.</div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                    What is your return policy?
                                </button>
                            </h2>
                            <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">We offer a 7-day return policy if you're not satisfied. Product must be unopened and in original condition. For quality issues, we offer instant replacement.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Related Products Section (Enhanced) -->
        <div class="mt-5 pt-4">
            <h3 class="mb-4 fw-bold text-dark border-start border-4 border-primary ps-3">
                Related Products
            </h3>
            <div class="row g-4">
                {% for i in random_products %}
                <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6">
                    <div class="card product-card h-100 border-0 shadow-sm">
                        
                        <a href="{% url 'shop:get_product_details' i.id %}" class="text-decoration-none">
                            <div class="product-image-wrapper position-relative">
                                <img src="{{ i.image.url|default:'https://images.unsplash.com/photo-1586201375761-83865001e31c?w=400' }}" 
                                     class="card-img-top product-img" alt="{{ i.name }}">
                                
                                {% if i.discount_percentage %}
                                <span class="badge bg-danger position-absolute top-0 start-0 m-2">
                                    -{{ i.discount_percentage }}%
                                </span>
                                {% endif %}
                            </div>
                        </a>

                        <div class="card-body d-flex flex-column">
                            <a href="{% url 'shop:get_product_details' i.id %}" class="text-decoration-none">
                                <h6 class="fw-semibold text-dark mb-2 product-name">
                                    {{ i.name|truncatechars:45 }}
                                </h6>
                            </a>

                            <div class="mb-2 small text-warning">
                                {% for star in "12345"|make_list %}<i class="bi bi-star-fill"></i>{% endfor %}
                                <span class="text-muted ms-2">({{ i.review_count|default:"24" }})</span>
                            </div>
                            
                            <div class="mt-auto">
                                {% if i.discount_price %}
                                    <span class="fw-bold text-success fs-6">₹{{ i.discount_price }}</span>
                                    <span class="text-muted text-decoration-line-through ms-2 small">₹{{ i.price }}</span>
                                {% else %}
                                    <span class="fw-bold text-success fs-6">₹{{ i.price }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-5 empty-state">
                    <i class="bi bi-box display-1 text-muted"></i>
                    <h5 class="text-muted mt-3">No Related Products Found</h5>
                    <p class="text-muted">Check back later for similar items.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
    .product-image-wrapper:hover .product-img {
        opacity: 0.9;
        transition: 0.3s;
    }
    .product-name:hover {
        color: #198754 !important;
    }
</style>

<!-- Global Quick View Modal (Single, improved) -->
<div class="modal fade" id="quickViewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-success"><i class="bi bi-eye me-2"></i>Quick View</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 text-center" id="quickViewModalBody">
                <div class="text-muted py-4">Select a product to preview</div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Continue browsing</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification (for cart feedback) -->
<div id="cartToast" class="toast-notification" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-icon">
        <i class="bi bi-check-lg"></i>
    </div>
    <div class="toast-content">
        <strong class="me-auto">Added to cart!</strong>
        <p class="mb-0 small text-muted" id="toastMessage">Product has been added.</p>
    </div>
</div>

<!-- Unified JavaScript: all improvements, zero duplication, respects original design -->
<script>
    (function() {
        "use strict";

        document.addEventListener('DOMContentLoaded', function() {
            
            const qtyInput = document.getElementById('productQty');
            const decBtn = document.getElementById('decrementQty');
            const incBtn = document.getElementById('incrementQty');

            if (qtyInput && decBtn && incBtn) {
                decBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    let val = parseInt(qtyInput.value, 10);
                    if (val > 1) qtyInput.value = val - 1;
                });
                incBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    let val = parseInt(qtyInput.value, 10);
                    let max = parseInt(qtyInput.getAttribute('max'), 10) || 10;
                    if (val < max) qtyInput.value = val + 1;
                });
                qtyInput.addEventListener('change', function() {
                    let val = parseInt(this.value, 10);
                    let min = parseInt(this.min, 10) || 1;
                    let max = parseInt(this.max, 10) || 10;
                    if (isNaN(val) || val < min) this.value = min;
                    if (val > max) this.value = max;
                });
            }

            const variantBtns = document.querySelectorAll('.variant-btn');
            if (variantBtns.length) {
                variantBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        variantBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
            }

            window.addToCart = function(btn) {
                const toast = document.getElementById('cartToast');
                const msg = document.getElementById('toastMessage');
                const qty = document.getElementById('productQty')?.value || 1;
                if (msg) msg.innerText = `Quantity: ${qty} item(s) added.`;
                if (toast) {
                    toast.classList.add('show');
                    setTimeout(() => toast.classList.remove('show'), 3000);
                }
                console.log('Added to cart', btn);
            };

            const modalEl = document.getElementById('quickViewModal');
            if (!modalEl) return;
            
            let quickViewModal;
            try {
                quickViewModal = new bootstrap.Modal(modalEl);
            } catch (e) {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    quickViewModal = new bootstrap.Modal(modalEl);
                }
            }

            document.querySelectorAll('.quick-view-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const productName = this.dataset.productName || 'Product';
                    const productImage = this.dataset.productImage || 'https://images.unsplash.com/photo-1586201375761-83865001e31c?w=600';
                    const productUrl = this.dataset.productUrl || '#';
                    
                    const modalBody = document.getElementById('quickViewModalBody');
                    if (!modalBody) return;
                    
                    modalBody.innerHTML = `
                        <div class="text-center py-5">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Fetching details...</p>
                        </div>
                    `;
                    
                    if (quickViewModal) quickViewModal.show();
                    
                    setTimeout(() => {
                        modalBody.innerHTML = `
                            <div class="row align-items-center text-start">
                                <div class="col-md-6 text-center mb-3 mb-md-0">
                                    <img src="${productImage}" class="img-fluid rounded shadow-sm" alt="${productName}" style="max-height: 280px; object-fit: contain;">
                                </div>
                                <div class="col-md-6">
                                    <h4 class="fw-bold mb-2">${productName}</h4>
                                    <div class="rating-stars mb-2 text-warning">
                                        <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                                        <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                                        <i class="bi bi-star-half"></i>
                                        <span class="ms-2 text-muted small">(24 reviews)</span>
                                    </div>
                                    <p class="text-muted mb-3">Premium quality product with amazing features and lasting durability.</p>
                                    <div class="d-flex gap-2 mb-3">
                                        <span class="badge bg-success p-2"><i class="bi bi-check-circle me-1"></i>In Stock</span>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <a href="${productUrl}" class="btn btn-success flex-grow-1">
                                            <i class="bi bi-cart-plus me-1"></i> View Product
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `;
                    }, 400);
                });
            });

            const mainImg = document.getElementById('mainProductImage');
            const thumbs = document.querySelectorAll('.thumbnail');
            if (thumbs.length && mainImg) {
                thumbs.forEach(thumb => {
                    thumb.addEventListener('click', function() {
                        mainImg.src = this.dataset.image;
                        thumbs.forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
            }
        });
    })();
</script>

<style>
    .product-overlay .quick-view-btn {
        background: white;
        color: var(--dark);
        border: 1px solid var(--border);
        font-size: 0.8rem;
        padding: 0.35rem 0.8rem;
    }
    .product-overlay .quick-view-btn i {
        margin-right: 4px;
    }
    .discount-badge {
        vertical-align: middle;
    }
    .back-btn i {
        font-size: 1.8rem;
    }
    .toast-notification {
        z-index: 9999;
    }
    .tab-content p:last-child {
        margin-bottom: 0;
    }
</style>

{% endblock %}